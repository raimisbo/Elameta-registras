{% extends "detaliu_registras/base.html" %}
{% load static formatting %}

{% block title %}Užklausos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/uzklausa_list.css' %}">
{% endblock %}

{% block content %}
<div class="uzklausos-page density-normal" data-theme="auto">
  <h1>Užklausos</h1>

  <div class="table-toolbar" role="toolbar" aria-label="Valdikliai">
    <!-- Grupės (mygtukai sugeneruojami JS pagal <th data-group="...">) -->
    <div class="groups">
      <span class="chip chip--badge">Grupės:</span>
      <!-- JS čia įterps mygtukus -->
    </div>

    <!-- „Stulpeliai“ meniu (JS sugeneruos varneles) -->
    <details class="colvis">
      <summary class="chip chip--ghost">Stulpeliai</summary>
      <div class="colvis-panel">
        <div class="colvis-grid js-colvis-grid"></div>
        <div class="colvis-actions">
          <button type="button" class="js-col-all chip chip--ghost">Rodyti visus</button>
          <button type="button" class="js-col-none chip chip--ghost">Slėpti visus</button>
          <button type="button" class="js-col-default chip chip--ghost">Numatytieji</button>
        </div>
      </div>
    </details>

    <!-- Tankis / Išplėstiniai / Tilpti lange -->
    <button type="button" class="chip chip--ghost js-density">Tankis: Įprastas</button>
    <button type="button" class="chip chip--ghost js-toggle-advanced">Išplėstiniai</button>
    <button type="button" class="chip chip--ghost js-fit-toggle">Tilpti lange</button>
    <span class="chip chip--badge js-fit-status" style="display:none;"></span>

    <!-- Veiksmas -->
    <a href="{% url 'detaliu_registras:uzklausa_create' %}" class="chip chip--ghost">Įvesti užklausą</a>
  </div>

  <!-- Filtrai per GET (server-side) -->
  <form id="filters-form" method="get">
    <div class="table-scroll">
      <table class="table table--compact">
        <thead>
          <tr>
            <!-- data-pin="1" – niekada neslėpti; data-priority – autoFit prioritetas (didesnis = slepiamas vėliau) -->
            <th data-col-index="0" data-group="bendra" data-pin="1" class="sticky-left-0">Klientas</th>
            <th data-col-index="1" data-group="bendra" data-pin="1" class="sticky-left-1">Projektas</th>

            <!-- ⬇️ Sujungtas stulpelis „Datos“: Užklausos ir Pasiūlymo datos viena po kitos -->
            <th data-col-index="2" data-group="bendra" data-priority="3">Datos</th>

            <th data-col-index="3" data-group="specs" data-priority="2">Detalė</th>
            <th data-col-index="4" data-group="specs" data-priority="3">Brėžinio Nr.</th>
            <th data-col-index="5" data-group="gamyba" data-advanced="1" data-priority="4" class="is-num">Kiekis/mėn.</th>
            <th data-col-index="6" data-group="bendra" data-pin="1" class="is-actions sticky-right-0">Veiksmai</th>
          </tr>

          <tr class="filters-row">
            <th data-col-index="0" class="sticky-left-0">
              <input name="f_klientas" class="filter-input" type="text" placeholder="filtruoti..." value="{{ request.GET.f_klientas|default_if_none:'' }}">
            </th>
            <th data-col-index="1" class="sticky-left-1">
              <input name="f_projektas" class="filter-input" type="text" placeholder="filtruoti..." value="{{ request.GET.f_projektas|default_if_none:'' }}">
            </th>

            <!-- ⬇️ Abu datų intervalai viename filtro stulpelyje -->
            <th data-col-index="2">
              <div class="filters-stack">
                <div class="row">
                  <span class="label">Užkl.</span>
                  <input name="f_uzklausos_data_from" class="filter-input" type="date" value="{{ request.GET.f_uzklausos_data_from|default_if_none:'' }}">
                  <input name="f_uzklausos_data_to"   class="filter-input" type="date" value="{{ request.GET.f_uzklausos_data_to|default_if_none:'' }}">
                </div>
                <div class="row">
                  <span class="label">Pasiūl.</span>
                  <input name="f_pasiulymo_data_from" class="filter-input" type="date" value="{{ request.GET.f_pasiulymo_data_from|default_if_none:'' }}">
                  <input name="f_pasiulymo_data_to"   class="filter-input" type="date" value="{{ request.GET.f_pasiulymo_data_to|default_if_none:'' }}">
                </div>
              </div>
            </th>

            <th data-col-index="3"><input name="f_detale" class="filter-input" type="text" placeholder="filtruoti..." value="{{ request.GET.f_detale|default_if_none:'' }}"></th>
            <th data-col-index="4"><input name="f_brezinio_nr" class="filter-input" type="text" placeholder="filtruoti..." value="{{ request.GET.f_brezinio_nr|default_if_none:'' }}"></th>

            <th data-col-index="5" data-advanced="1">
              <div class="num-range">
                <input name="f_kiekis_min" class="filter-input" type="number" min="0" step="1" placeholder="nuo" value="{{ request.GET.f_kiekis_min|default_if_none:'' }}">
                <input name="f_kiekis_max" class="filter-input" type="number" min="0" step="1" placeholder="iki" value="{{ request.GET.f_kiekis_max|default_if_none:'' }}">
              </div>
            </th>

            <th data-col-index="6" class="is-actions sticky-right-0">
              <button type="submit" class="chip chip--ghost">Filtruoti</button>
              <a href="." class="chip chip--ghost">Išvalyti</a>
            </th>
          </tr>
        </thead>

        <tbody id="uzklausos-body">
          {% for uzklausa in uzklausos %}
          <tr class="data-row" data-pk="{{ uzklausa.pk }}">
            <td data-col-index="0" class="sticky-left-0">{{ uzklausa.klientas.vardas|default:"-" }}</td>
            <td data-col-index="1" class="sticky-left-1">{{ uzklausa.projektas.pavadinimas|default:"-" }}</td>

            <!-- ⬇️ Viena po kitos: „Užkl.“ ir „Pasiūl.“ -->
            <td data-col-index="2">
              <div class="substack">
                <div class="subline"><span class="tag">Užkl.</span> {{ uzklausa.projektas.uzklausos_data|date_start|date:"Y-m-d"|default:"-" }}</div>
                <div class="subline"><span class="tag">Pasiūl.</span> {{ uzklausa.projektas.pasiulymo_data|date_start|date:"Y-m-d"|default:"-" }}</div>
              </div>
            </td>

            <td data-col-index="3">{{ uzklausa.detale.pavadinimas|default:"-" }}</td>
            <td data-col-index="4">{{ uzklausa.detale.brezinio_nr|default:"-" }}</td>
            <td data-col-index="5" data-advanced="1" class="is-num">{{ uzklausa.detale.kiekis_menesis|default:"-" }}</td>

            <td data-col-index="6" class="is-actions sticky-right-0">
              <a class="chip chip--ghost" href="{% url 'detaliu_registras:uzklausa_detail' pk=uzklausa.pk %}">Peržiūrėti</a>
              <!-- svarbu: tavo urls.py tikisi keyword 'uzklausa_pk' -->
              <a class="chip chip--ghost" href="{% url 'detaliu_registras:kaina_update' uzklausa_pk=uzklausa.pk %}">Kaina</a>

              <!-- AJAX mygtukas „Detaliau“ -->
              <button type="button"
                      class="chip chip--ghost js-row-details"
                      data-details-url="{% url 'detaliu_registras:uzklausa_details' pk=uzklausa.pk %}"
                      aria-expanded="false">
                Detaliau
              </button>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="100">Nėra įrašų</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>

  <div class="pagination pagination--chips">
    {% if page_obj.has_previous %}
      <a class="chip chip--ghost" href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ page_obj.previous_page_number }}">« Atgal</a>
    {% endif %}
    <span class="page-info">Puslapis {{ page_obj.number }} iš {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a class="chip chip--ghost" href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ page_obj.next_page_number }}">Pirmyn »</a>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/colfilters.js' %}"></script>
{% endblock %}

